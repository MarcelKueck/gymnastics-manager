// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ATHLETE
  TRAINER
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum YouthCategory {
  F
  E
  D
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum RecurrenceInterval {
  ONCE
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum AttendanceStatus {
  PRESENT
  ABSENT_UNEXCUSED
  ABSENT_EXCUSED
}

enum AthleteStatus {
  PENDING
  ACTIVE
  INACTIVE
}

// ============================================================================
// USER MODELS
// ============================================================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  firstName    String
  lastName     String
  phone        String
  birthDate    DateTime?
  gender       Gender?

  // Dual role flags
  isAthlete Boolean @default(false)
  isTrainer Boolean @default(false)

  // Profile relationships
  athleteProfile      AthleteProfile?
  trainerProfile      TrainerProfile?
  passwordResetTokens PasswordResetToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isAthlete, isTrainer])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

model AthleteProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Status
  status AthleteStatus @default(PENDING)

  // Guardian information (for minors)
  guardianName          String?
  guardianEmail         String?
  guardianPhone         String?
  emergencyContactName  String?
  emergencyContactPhone String?

  // Training configuration (managed by trainers)
  youthCategory            YouthCategory @default(F)
  competitionParticipation Boolean       @default(false)
  hasDtbId                 Boolean       @default(false)

  // Approval status
  isApproved        Boolean         @default(false)
  approvedBy        String?
  approvedByTrainer TrainerProfile? @relation("AthleteApprovals", fields: [approvedBy], references: [id])
  approvedAt        DateTime?
  configuredAt      DateTime?

  // Preferences
  autoConfirmFutureSessions Boolean @default(false)

  // Relationships
  recurringTrainingAssignments RecurringTrainingAthleteAssignment[]
  sessionAthleteAssignments    SessionAthleteAssignment[]
  cancellations                Cancellation[]
  attendanceRecords            AttendanceRecord[]
  absenceAlerts                AbsenceAlert[]
  competitionRegistrations     CompetitionRegistration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isApproved])
  @@index([youthCategory])
}

model TrainerProfile {
  id       String   @id @default(cuid())
  userId   String   @unique
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role     UserRole @default(TRAINER)
  isActive Boolean  @default(true)

  // Relationships
  approvedAthletes              AthleteProfile[]                     @relation("AthleteApprovals")
  createdRecurringTrainings     RecurringTraining[]                  @relation("RecurringTrainingCreator")
  recurringTrainingAssignments  RecurringTrainingTrainerAssignment[] @relation("RecurringTrainingAssignments")
  recurringAthleteAssignments   RecurringTrainingAthleteAssignment[] @relation("AthleteAssignmentCreator")
  trainerAssignmentsCreated     RecurringTrainingTrainerAssignment[] @relation("TrainerAssignmentCreator")
  sessionGroupAssignments       SessionGroupTrainerAssignment[]
  sessionAthleteReassignments   SessionAthleteAssignment[]           @relation("SessionAthleteReassignments")
  uploads                       Upload[]
  attendanceMarked              AttendanceRecord[]
  auditLogs                     AuditLog[]
  monthlyHoursSummaries         MonthlyTrainerSummary[]              @relation("TrainerMonthlySummaries")
  modifiedMonthlyHoursSummaries MonthlyTrainerSummary[]              @relation("TrainerSummaryModifier")
  modifiedSystemSettings        SystemSettings[]
  createdCompetitions           Competition[]                        @relation("CompetitionCreator")
  cancelledSessions             TrainingSession[]                    @relation("SessionCanceller")
  acknowledgedAlerts            AbsenceAlert[]
  trainerCancellations          TrainerCancellation[]
  trainerAttendance             TrainerAttendanceRecord[]            @relation("TrainerAttendance")
  markedTrainerAttendance       TrainerAttendanceRecord[]            @relation("TrainerAttendanceMarker")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([role])
  @@index([isActive])
}

// ============================================================================
// TRAINING STRUCTURE MODELS
// ============================================================================

model RecurringTraining {
  id         String             @id @default(cuid())
  name       String
  dayOfWeek  DayOfWeek
  startTime  String // HH:MM format
  endTime    String // HH:MM format
  recurrence RecurrenceInterval @default(WEEKLY)
  isActive   Boolean            @default(true)
  validFrom  DateTime?
  validUntil DateTime?

  createdBy        String
  createdByTrainer TrainerProfile @relation("RecurringTrainingCreator", fields: [createdBy], references: [id])

  // Relationships
  trainingGroups   TrainingGroup[]
  trainingSessions TrainingSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dayOfWeek])
  @@index([isActive])
}

model TrainingGroup {
  id                  String            @id @default(cuid())
  recurringTrainingId String
  recurringTraining   RecurringTraining @relation(fields: [recurringTrainingId], references: [id], onDelete: Cascade)
  name                String
  sortOrder           Int               @default(0)

  // Relationships
  athleteAssignments RecurringTrainingAthleteAssignment[]
  trainerAssignments RecurringTrainingTrainerAssignment[]
  sessionGroups      SessionGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recurringTrainingId])
}

model RecurringTrainingAthleteAssignment {
  id                String         @id @default(cuid())
  trainingGroupId   String
  trainingGroup     TrainingGroup  @relation(fields: [trainingGroupId], references: [id], onDelete: Cascade)
  athleteId         String
  athlete           AthleteProfile @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  assignedBy        String
  assignedByTrainer TrainerProfile @relation("AthleteAssignmentCreator", fields: [assignedBy], references: [id])
  assignedAt        DateTime       @default(now())

  @@unique([trainingGroupId, athleteId])
  @@index([trainingGroupId])
  @@index([athleteId])
}

model RecurringTrainingTrainerAssignment {
  id                String         @id @default(cuid())
  trainingGroupId   String
  trainingGroup     TrainingGroup  @relation(fields: [trainingGroupId], references: [id], onDelete: Cascade)
  trainerId         String
  trainer           TrainerProfile @relation("RecurringTrainingAssignments", fields: [trainerId], references: [id], onDelete: Cascade)
  isPrimary         Boolean        @default(false)
  effectiveFrom     DateTime?
  effectiveUntil    DateTime?
  assignedBy        String
  assignedByTrainer TrainerProfile @relation("TrainerAssignmentCreator", fields: [assignedBy], references: [id])

  @@unique([trainingGroupId, trainerId])
  @@index([trainingGroupId])
  @@index([trainerId])
}

// ============================================================================
// SESSION MODELS
// ============================================================================

model TrainingSession {
  id                  String             @id @default(cuid())
  date                DateTime
  dayOfWeek           DayOfWeek
  startTime           String? // Override from recurring
  endTime             String? // Override from recurring
  recurringTrainingId String?
  recurringTraining   RecurringTraining? @relation(fields: [recurringTrainingId], references: [id], onDelete: SetNull)
  notes               String?
  isCompleted         Boolean            @default(false)
  isCancelled         Boolean            @default(false)
  cancelledBy         String?
  cancelledByTrainer  TrainerProfile?    @relation("SessionCanceller", fields: [cancelledBy], references: [id])
  cancelledAt         DateTime?
  cancellationReason  String?

  // Relationships
  sessionGroups             SessionGroup[]
  sessionAthleteAssignments SessionAthleteAssignment[]
  cancellations             Cancellation[]
  trainerCancellations      TrainerCancellation[]
  trainerAttendanceRecords  TrainerAttendanceRecord[]
  attendanceRecords         AttendanceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([recurringTrainingId])
  @@index([isCancelled])
}

model SessionGroup {
  id                String          @id @default(cuid())
  trainingSessionId String
  trainingSession   TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  trainingGroupId   String
  trainingGroup     TrainingGroup   @relation(fields: [trainingGroupId], references: [id], onDelete: Cascade)
  exercises         String? // Exercise plan for this session
  notes             String?

  // Relationships
  trainerAssignments SessionGroupTrainerAssignment[]

  @@unique([trainingSessionId, trainingGroupId])
  @@index([trainingSessionId])
  @@index([trainingGroupId])
}

model SessionGroupTrainerAssignment {
  id             String          @id @default(cuid())
  sessionGroupId String
  sessionGroup   SessionGroup    @relation(fields: [sessionGroupId], references: [id], onDelete: Cascade)
  trainerId      String?
  trainer        TrainerProfile? @relation(fields: [trainerId], references: [id], onDelete: SetNull)

  @@index([sessionGroupId])
  @@index([trainerId])
}

model SessionAthleteAssignment {
  id                String          @id @default(cuid())
  trainingSessionId String
  trainingSession   TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  sessionGroupId    String
  athleteId         String
  athlete           AthleteProfile  @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  movedBy           String
  movedByTrainer    TrainerProfile  @relation("SessionAthleteReassignments", fields: [movedBy], references: [id])
  movedAt           DateTime        @default(now())
  reason            String?

  @@unique([trainingSessionId, athleteId])
  @@index([trainingSessionId])
  @@index([athleteId])
}

// ============================================================================
// ATTENDANCE MODELS
// ============================================================================

model Cancellation {
  id                String          @id @default(cuid())
  athleteId         String
  athlete           AthleteProfile  @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  trainingSessionId String
  trainingSession   TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  reason            String // Minimum 10 characters
  cancelledAt       DateTime        @default(now())
  isActive          Boolean         @default(true)
  undoneAt          DateTime?

  @@unique([athleteId, trainingSessionId])
  @@index([athleteId])
  @@index([trainingSessionId])
  @@index([isActive])
}

model TrainerCancellation {
  id                String          @id @default(cuid())
  trainerId         String
  trainer           TrainerProfile  @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  trainingSessionId String
  trainingSession   TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  reason            String // Minimum 10 characters
  cancelledAt       DateTime        @default(now())
  isActive          Boolean         @default(true)
  undoneAt          DateTime?

  @@unique([trainerId, trainingSessionId])
  @@index([trainerId])
  @@index([trainingSessionId])
  @@index([isActive])
}

model TrainerAttendanceRecord {
  id                 String           @id @default(cuid())
  trainerId          String
  trainer            TrainerProfile   @relation("TrainerAttendance", fields: [trainerId], references: [id], onDelete: Cascade)
  trainingSessionId  String
  trainingSession    TrainingSession  @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  status             AttendanceStatus
  markedBy           String
  markedByAdmin      TrainerProfile   @relation("TrainerAttendanceMarker", fields: [markedBy], references: [id])
  markedAt           DateTime         @default(now())
  lastModifiedBy     String?
  lastModifiedAt     DateTime?
  modificationReason String?
  notes              String?

  @@unique([trainerId, trainingSessionId])
  @@index([trainerId])
  @@index([trainingSessionId])
  @@index([status])
}

model AttendanceRecord {
  id                 String           @id @default(cuid())
  athleteId          String
  athlete            AthleteProfile   @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  trainingSessionId  String
  trainingSession    TrainingSession  @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  status             AttendanceStatus
  markedBy           String
  markedByTrainer    TrainerProfile   @relation(fields: [markedBy], references: [id])
  markedAt           DateTime         @default(now())
  lastModifiedBy     String?
  lastModifiedAt     DateTime?
  modificationReason String?
  notes              String?

  @@unique([athleteId, trainingSessionId])
  @@index([athleteId])
  @@index([trainingSessionId])
  @@index([status])
}

// ============================================================================
// COMPETITION MODELS
// ============================================================================

model Competition {
  id                   String         @id @default(cuid())
  name                 String
  date                 DateTime
  location             String
  description          String?
  minYouthCategory     YouthCategory?
  maxYouthCategory     YouthCategory?
  registrationDeadline DateTime?
  maxParticipants      Int?
  requiresDtbId        Boolean        @default(false)
  entryFee             Decimal?       @db.Decimal(10, 2)
  isPublished          Boolean        @default(false)
  isCancelled          Boolean        @default(false)
  createdBy            String
  createdByTrainer     TrainerProfile @relation("CompetitionCreator", fields: [createdBy], references: [id])

  // Relationships
  registrations CompetitionRegistration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([isPublished])
}

model CompetitionRegistration {
  id            String         @id @default(cuid())
  competitionId String
  competition   Competition    @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  athleteId     String
  athlete       AthleteProfile @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  registeredAt  DateTime       @default(now())
  notes         String?
  attended      Boolean?
  placement     Int?
  score         Decimal?       @db.Decimal(10, 2)

  @@unique([competitionId, athleteId])
  @@index([competitionId])
  @@index([athleteId])
}

// ============================================================================
// FILE MANAGEMENT MODELS
// ============================================================================

model UploadCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  // Relationships
  uploads Upload[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Upload {
  id                String         @id @default(cuid())
  categoryId        String
  category          UploadCategory @relation(fields: [categoryId], references: [id])
  title             String
  targetDate        String? // e.g., "KW 23" for week 23
  filePath          String
  fileName          String
  fileSize          Int
  mimeType          String
  uploadedBy        String
  uploadedByTrainer TrainerProfile @relation(fields: [uploadedBy], references: [id])
  uploadedAt        DateTime       @default(now())
  version           Int            @default(1)
  replacedBy        String?
  isActive          Boolean        @default(true)

  @@index([categoryId])
  @@index([isActive])
}

// ============================================================================
// ADMINISTRATIVE MODELS
// ============================================================================

model SystemSettings {
  id                         String  @id @default("default")
  cancellationDeadlineHours  Int     @default(2)
  absenceAlertThreshold      Int     @default(3)
  absenceAlertWindowDays     Int     @default(30)
  absenceAlertCooldownDays   Int     @default(14)
  adminNotificationEmail     String  @default("")
  absenceAlertEnabled        Boolean @default(true)
  maxUploadSizeMB            Int     @default(10)
  sessionGenerationDaysAhead Int     @default(90)

  lastModifiedBy        String?
  lastModifiedByTrainer TrainerProfile? @relation(fields: [lastModifiedBy], references: [id])
  lastModifiedAt        DateTime?
}

model AbsenceAlert {
  id                 String          @id @default(cuid())
  athleteId          String
  athlete            AthleteProfile  @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  absenceCount       Int
  period             Int             @default(30) // Days in the absence period
  createdAt          DateTime        @default(now())
  acknowledged       Boolean         @default(false)
  acknowledgedAt     DateTime?
  acknowledgedBy     String?
  acknowledgedByUser TrainerProfile? @relation(fields: [acknowledgedBy], references: [id])

  @@index([athleteId])
  @@index([createdAt])
}

model AuditLog {
  id                 String         @id @default(cuid())
  entityType         String // 'athlete', 'training', 'attendance', etc.
  entityId           String
  action             String // 'create', 'update', 'delete', 'approve', etc.
  changes            Json // { field: { old: value, new: value } }
  performedBy        String
  performedByTrainer TrainerProfile @relation(fields: [performedBy], references: [id])
  performedAt        DateTime       @default(now())
  reason             String?

  @@index([entityType, entityId])
  @@index([performedBy])
  @@index([performedAt])
}

model MonthlyTrainerSummary {
  id                    String          @id @default(cuid())
  month                 Int // 1-12
  year                  Int
  trainerId             String
  trainer               TrainerProfile  @relation("TrainerMonthlySummaries", fields: [trainerId], references: [id], onDelete: Cascade)
  calculatedHours       Decimal         @db.Decimal(10, 2)
  adjustedHours         Decimal?        @db.Decimal(10, 2)
  finalHours            Decimal         @db.Decimal(10, 2)
  notes                 String?
  lastModifiedBy        String?
  lastModifiedByTrainer TrainerProfile? @relation("TrainerSummaryModifier", fields: [lastModifiedBy], references: [id])
  lastModifiedAt        DateTime?

  @@unique([month, year, trainerId])
  @@index([trainerId])
  @@index([year, month])
}
